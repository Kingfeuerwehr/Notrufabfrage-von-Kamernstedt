<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Notrufabfrage ‚Ä¢ AAO (vollst√§ndige Version)</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>.btn{border-radius:1rem;padding:.5rem .75rem;box-shadow:0 1px 2px rgba(0,0,0,.1);}</style>
</head>
<body class="bg-slate-50 min-h-screen">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useMemo } = React;

    // ===== AAO Grundtabelle =====
    const AAO = [
      // RD
      { Stichwort: "Krankentransport", Fahrzeuge_AAO: "NKTW oder RTW", Info: null },
      { Stichwort: "Notfall 1", Fahrzeuge_AAO: "RTW oder NKTW", Info: "Allgemeiner Notfall" },
      { Stichwort: "Hilflose Person", Fahrzeuge_AAO: "RTW oder NKTW", Info: "Hilfeleistung Person" },
      { Stichwort: "Trauma", Fahrzeuge_AAO: "RTW", Info: "Trauma ohne Polytrauma" },
      { Stichwort: "Notfall 2", Fahrzeuge_AAO: "RTW", Info: "kritischer Notfall" },
      { Stichwort: "Reanimation", Fahrzeuge_AAO: "RTW, ggf. NEF", Info: "CPR/Herzstillstand" },
      { Stichwort: "Polytrauma", Fahrzeuge_AAO: "RTH & NEF & RTW", Info: "Schwerstverletzte" },

      // Brand
      { Stichwort: "B - 1", Fahrzeuge_AAO: "TLF oder (H)LF", Info: "Kleinbrand / PKW / Container / Kamin" },
      { Stichwort: "B - 2", Fahrzeuge_AAO: "ELW, 2x (H)LF, DLK, TLF & RTW", Info: "Wohnung / Dachstuhl / LKW" },
      { Stichwort: "B - 3", Fahrzeuge_AAO: "ELW, 3x (H)LF, DLK, 2x TLF & RTW", Info: "Industriebrand gro√ü / Landwirtschaft" },
      { Stichwort: "B - 2Y", Fahrzeuge_AAO: "ELW, 2x (H)LF, DLK, TLF & NEF, 2x RTW", Info: "Brand mit 1 Person in Gefahr" },
      { Stichwort: "B - 3Y", Fahrzeuge_AAO: "ELW, 3x (H)LF, DLK, 2x TLF & NEF, 3x RTW", Info: "Brand mit 2 Personen in Gefahr" },
      { Stichwort: "B - 4Y", Fahrzeuge_AAO: "ELW, 3x (H)LF, DLK, 2x TLF & 2x NEF, 4x RTW", Info: "Brand mit 3+ Personen in Gefahr" },

      // TH
      { Stichwort: "TH - 1", Fahrzeuge_AAO: "HLF", Info: "Technische Hilfe klein" },
      { Stichwort: "TH - 2", Fahrzeuge_AAO: "HLF, RW", Info: "Technische Hilfe mittel" },
      { Stichwort: "TH - 3", Fahrzeuge_AAO: "ELW, 2x HLF, RW, TLF", Info: "Technische Hilfe gro√ü" },
      { Stichwort: "TH - VU", Fahrzeuge_AAO: "HLF, RW, RTW", Info: "Verkehrsunfall" },
      { Stichwort: "TH - P-klemmt", Fahrzeuge_AAO: "ELW, HLF, RW, TLF & NEF, 2x RTW", Info: "VU / Person eingeklemmt" },
      { Stichwort: "TH - Wasser", Fahrzeuge_AAO: "HLF, Boot, GW-W", Info: "Wassernotlage" },
      { Stichwort: "TH - H√∂hen/Tiefen", Fahrzeuge_AAO: "HLF, R√ºstwagen, H√∂henretter", Info: "Rettung aus H√∂hen oder Tiefen" },
      { Stichwort: "TH - Gas 1", Fahrzeuge_AAO: "HLF", Info: "Gasgeruch" },
      { Stichwort: "TH - Gas 2", Fahrzeuge_AAO: "HLF, GW-G oder AB-G", Info: "Gasleitung besch√§digt" },

      // MANV/Sonderlage
      { Stichwort: "MANV-1", Fahrzeuge_AAO: "3x RTW, 2x NEF, 1x NKTW, LF KatS, LNA, San-Zug", Info: "5-9 Verletzte" },
      { Stichwort: "MANV-2", Fahrzeuge_AAO: "+ ORGL, ELRD, Betreuungszug", Info: "10-19 Verletzte" },
      { Stichwort: "MANV-3", Fahrzeuge_AAO: "+ √ÑLRD, Versorgungszug", Info: "20-29 Verletzte" },
      { Stichwort: "RDAZ-1", Fahrzeuge_AAO: "2x RTW oder NKTW & 1x NEF", Info: "RD-Ausnahmezustand 1" },
      { Stichwort: "AL/TL", Fahrzeuge_AAO: "2x RTW, 1x NEF, LF KatS, LNA, ORGL, San-, Betreuungs-, F√ºhrungszug", Info: "Amok-/Terror-Lage" },
    ];
    const byKey = (k) => AAO.find(e => e.Stichwort.toLowerCase() === (k||'').toLowerCase()) || null;

    // ===== Eingabemodell =====
    const RD_SUBS = ["Notfall 1", "Hilflose Person", "Trauma", "Notfall 2", "Reanimation", "Polytrauma", "Krankentransport"];
    const BRAND_EXTRAS = ["Garage", "Dachstuhl", "Keller", "Industrie", "Landwirtschaft"];
    const TH_LIST = AAO.filter(e => e.Stichwort.startsWith("TH")).map(e => e.Stichwort);

    function pickAAO(a) {
      // MANV
      if (a.category === "MANV/Sonderlage") {
        const v = num(a.personsInDanger);
        if (/(amok|terror|schusswaffe|explosion)/i.test(a.details)) return byKey("AL/TL");
        if (v >= 20) return byKey("MANV-3");
        if (v >= 10) return byKey("MANV-2");
        if (v >= 5)  return byKey("MANV-1");
        return byKey("RDAZ-1");
      }
      // Brand
      if (a.category === "Brand") {
        const p = num(a.personsInDanger);
        if (p >= 3) return byKey("B - 4Y");
        if (p === 2) return byKey("B - 3Y");
        if (p === 1) return byKey("B - 2Y");
        if (a.fireSize === "gross")  return byKey("B - 3");
        if (a.fireSize === "mittel") return byKey("B - 2");
        return byKey("B - 1");
      }
      // TH
      if (a.category === "Technische Hilfe") {
        return byKey(a.thType) || null;
      }
      // RD mit Unterstichworten
      if (a.category === "Rettungsdienst") {
        if (a.rdSub && byKey(a.rdSub)) return byKey(a.rdSub);
        const details = (a.details||"").toLowerCase();
        if ((a.unconscious === "ja" && a.breathing === "nein") || /reani|cpr|herzstillstand/.test(details)) return byKey("Reanimation");
        if (/polytrauma|mehrfachverletz|hochrasanz|sturz\s*>\s*3m/.test(details)) return byKey("Polytrauma");
        if (a.unconscious === "ja" || a.breathing === "nein") return byKey("Notfall 2");
        if (/hilflos|sturz|tuere √∂ffnen|wohnungstuer|kein kontakt/.test(details)) return byKey("Hilflose Person");
        if (/trauma|sturz|fraktur|blutung/.test(details)) return byKey("Trauma");
        if (/transport|verlegung|ktp|krankentransport/.test(details)) return byKey("Krankentransport");
        return byKey("Notfall 1");
      }
      return null;
    }

    function num(v){ return typeof v === "number" ? v : (v === "" ? 0 : Number(v)); }

    function buildMail(a, entry) {
      let info = entry && entry.Info ? entry.Info : "(keine)";
      if (a.category === "Brand" && a.brandExtras && a.brandExtras.length) {
        info = (info === "(keine)" ? "" : info + "; ") + "Zusatz: " + a.brandExtras.join(", ");
      }
      const subject = entry ? entry.Stichwort : "Voranfrage";
      const lines = [
        `Stichwort: ${entry ? entry.Stichwort : "(offen)"}`,
        `AAO Fahrzeuge: ${entry ? (entry.Fahrzeuge_AAO || "(offen)") : "(offen)"}`,
        `Info: ${info}`,
        `‚Äî`,
        `Melder: ${a.callerName || "(unbekannt)"}`,
        `R√ºckruf: ${a.callbackNumber || "(unbekannt)"}`,
        `Adresse/PLZ: ${a.location || "(unbekannt)"}`,
        `Details: ${a.details || "(keine)"}`,
        `Kategorie: ${a.category || "(unbekannt)"}`,
        `Personen in Gefahr/Verletzt: ${a.personsInDanger === "" ? "(unbekannt)" : a.personsInDanger}`,
        `Bewusst/Atmung (nur RD): ${a.unconscious}/${a.breathing}`,
        `Brandgr√∂√üe (nur Brand): ${a.fireSize || "(k.A.)"}`,
        `TH-Typ (nur TH): ${a.thType || "(k.A.)"}`,
        `RD-Unterstichwort: ${a.rdSub || "(k.A.)"}`,
      ];
      const body = lines.join("\n");
      const mailto = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      return { subject, body, mailto, info };
    }

    function buildAlarmText(a, entry, maxLen = 160) {
      const parts = [];
      parts.push(entry?.Stichwort || "(Stichwort)");
      if (a.location) parts.push(a.location);
      const p = num(a.personsInDanger);
      if (p > 0) parts.push(`P:${p}`);
      if (a.category === "Brand") {
        if (a.fireSize) parts.push(`B:${a.fireSize}`);
        if (a.brandExtras?.length) parts.push("Z:" + a.brandExtras.join(","));
      }
      if (a.category === "Technische Hilfe" && a.thType) parts.push(`TH:${a.thType}`);
      if (a.category === "Rettungsdienst") {
        if (a.rdSub) parts.push(`RD:${a.rdSub}`);
        if (a.unconscious !== "unbekannt") parts.push(`Bew:${a.unconscious}`);
        if (a.breathing !== "unbekannt") parts.push(`Atm:${a.breathing}`);
      }
      const hint = (entry?.Info || "").trim();
      const det = (a.details || "").trim();
      const hintShort = (hint || det).replace(/\s+/g, " ").slice(0, 60);
      if (hintShort) parts.push(hintShort);
      if (a.callbackNumber) parts.push(`RK:${a.callbackNumber}`);
      if (a.callerName) parts.push(`M:${a.callerName}`);

      let text = parts.filter(Boolean).join(" | ").replace(/\s+/g, " ").trim();
      if (text.length > maxLen) text = text.slice(0, maxLen - 1) + "‚Ä¶";
      return text;
    }

    const LabeledInput = ({label, value, onChange}) => (
      <label className="block mb-3">
        <span className="block text-sm font-medium mb-1">{label}</span>
        <input className="w-full border rounded-xl p-2" value={value} onChange={(e)=>onChange(e.target.value)} />
      </label>
    );
    const NumberInput = ({label, value, onChange}) => (
      <label className="block mb-3">
        <span className="block text-sm font-medium mb-1">{label}</span>
        <input type="number" min="0" className="w-full border rounded-xl p-2" value={value}
               onChange={(e)=>onChange(e.target.value===""?"":Number(e.target.value))} />
      </label>
    );
    const LabeledTextArea = ({label, value, onChange, rows=3}) => (
      <label className="block mb-3">
        <span className="block text-sm font-medium mb-1">{label}</span>
        <textarea className="w-full border rounded-xl p-2" rows={rows} value={value} onChange={(e)=>onChange(e.target.value)} />
      </label>
    );
    const Select = ({label, value, options, onChange}) => (
      <label className="block mb-3">
        <span className="block text-sm font-medium mb-1">{label}</span>
        <select className="w-full border rounded-xl p-2 bg-white" value={value} onChange={(e)=>onChange(e.target.value)}>
          {options.map(o => <option key={o} value={o}>{o || "‚Äî ausw√§hlen ‚Äî"}</option>)}
        </select>
      </label>
    );
    const Row = ({label, value, multiline=false}) => (
      <div>
        <div className="text-xs text-slate-500">{label}</div>
        {multiline ? <div className="text-sm whitespace-pre-line">{value}</div> : <div className="text-sm">{value}</div>}
      </div>
    );

    function Checkbox({label, checked, onChange}) {
      return (
        <label className="inline-flex items-center gap-2 mr-3 mb-2">
          <input type="checkbox" className="w-4 h-4" checked={checked} onChange={(e)=>onChange(e.target.checked)} />
          <span className="text-sm">{label}</span>
        </label>
      );
    }

    function App() {
      const [a, setA] = useState({
        category: "",
        personsInDanger: "",
        unconscious: "unbekannt",
        breathing: "unbekannt",
        thType: "",
        fireSize: "",
        brandExtras: [],
        rdSub: "",
        details: "",
        callerName: "",
        callbackNumber: "",
        location: "",
      });
      const entry = useMemo(()=>pickAAO(a), [a]);
      const mail  = useMemo(()=>buildMail(a, entry), [a, entry]);
      const alarm = useMemo(()=>buildAlarmText(a, entry), [a, entry]);

      const setField = (k, v) => setA(s => ({...s, [k]: v}));
      const toggleExtra = (x) => setA(s => {
        const set = new Set(s.brandExtras);
        set.has(x) ? set.delete(x) : set.add(x);
        return {...s, brandExtras: [...set]};
      });

      return (
        <div className="min-h-screen bg-slate-50 p-6">
          <div className="mx-auto max-w-6xl">
            <h1 className="text-2xl font-bold tracking-tight">Notrufabfrage ‚Ä¢ AAO (vollst√§ndig)</h1>

            <div className="grid lg:grid-cols-3 gap-4 mt-6">
              {/* Eingabe */}
              <section className="lg:col-span-2 bg-white rounded-2xl shadow p-4">
                <h2 className="font-semibold mb-3">Einsatzdaten</h2>
                <div className="grid md:grid-cols-2 gap-2">
                  <LabeledInput label="Melder-Name" value={a.callerName} onChange={(v)=>setField("callerName", v)} />
                  <LabeledInput label="R√ºckrufnummer" value={a.callbackNumber} onChange={(v)=>setField("callbackNumber", v)} />
                </div>
                <LabeledInput label="Adresse/PLZ" value={a.location} onChange={(v)=>setField("location", v)} />

                <Select label="Kategorie" value={a.category} onChange={(v)=>setField("category", v)} options={["", "Rettungsdienst", "Brand", "Technische Hilfe", "MANV/Sonderlage"]} />

                {a.category === "Rettungsdienst" && (
                  <div className="grid md:grid-cols-2 gap-2">
                    <Select label="RD-Unterstichwort" value={a.rdSub} onChange={(v)=>setField("rdSub", v)} options={["", ...RD_SUBS]} />
                    <div className="grid grid-cols-2 gap-2">
                      <Select label="Bewusstlos?" value={a.unconscious} onChange={(v)=>setField("unconscious", v)} options={["unbekannt","ja","nein"]} />
                      <Select label="Atmung vorhanden?" value={a.breathing} onChange={(v)=>setField("breathing", v)} options={["unbekannt","ja","nein"]} />
                    </div>
                    <NumberInput label="Betroffene/Verletzte" value={a.personsInDanger} onChange={(v)=>setField("personsInDanger", v)} />
                  </div>
                )}

                {a.category === "Brand" && (
                  <div>
                    <div className="grid md:grid-cols-2 gap-2">
                      <NumberInput label="Personen in Gefahr" value={a.personsInDanger} onChange={(v)=>setField("personsInDanger", v)} />
                      <Select label="Brandgr√∂√üe" value={a.fireSize} onChange={(v)=>setField("fireSize", v)} options={["", "klein", "mittel", "gross"]} />
                    </div>
                    <div className="mt-2">
                      <div className="text-sm font-medium mb-1">Zusatz (Garage, Dachstuhl ‚Ä¶)</div>
                      {BRAND_EXTRAS.map(x => <Checkbox key={x} label={x} checked={a.brandExtras.includes(x)} onChange={()=>toggleExtra(x)} />)}
                    </div>
                  </div>
                )}

                {a.category === "Technische Hilfe" && (
                  <div className="grid md:grid-cols-2 gap-2">
                    <Select label="TH-Stichwort" value={a.thType} onChange={(v)=>setField("thType", v)} options={["", ...TH_LIST]} />
                    <NumberInput label="Betroffene (optional)" value={a.personsInDanger} onChange={(v)=>setField("personsInDanger", v)} />
                  </div>
                )}

                {a.category === "MANV/Sonderlage" && (
                  <div className="grid md:grid-cols-2 gap-2">
                    <NumberInput label="Verletzte/Betroffene" value={a.personsInDanger} onChange={(v)=>setField("personsInDanger", v)} />
                    <LabeledInput label="Schl√ºsselw√∂rter (z. B. Amok/Terror)" value={a.details} onChange={(v)=>setField("details", v)} />
                  </div>
                )}

                <LabeledTextArea label="Zusatzinfos (frei)" value={a.details} onChange={(v)=>setField("details", v)} rows={3} />
              </section>

              {/* Ergebnis */}
              <section className="lg:col-span-1 bg-white rounded-2xl shadow p-4">
                <h2 className="font-semibold mb-3">Ergebnis</h2>
                <div className="space-y-2 text-sm">
                  <Row label="Stichwort" value={entry?.Stichwort || "(nicht bestimmt)"} />
                  <Row label="Fahrzeuge" value={entry?.Fahrzeuge_AAO || "(offen)"} />
                  <Row label="Info" value={mail.info || "(keine)"} multiline />
                </div>

                <div className="border-t my-3" />
                <h3 className="font-medium mb-1">Alarmtext (Melder) <span className="text-xs text-slate-500">({alarm.length}/160)</span></h3>
                <textarea className="w-full border rounded-xl p-2 text-sm" rows="4" readOnly value={alarm} />
                <div className="flex items-center gap-2 mt-2">
                  <button className="btn bg-slate-800 text-white text-sm" onclick="navigator.clipboard.writeText(this.parentElement.previousElementSibling.value)">üìã Text kopieren</button>
                </div>

                <div className="border-t my-3" />
                <h3 className="font-medium mb-1">Mailer</h3>
                <textarea className="w-full border rounded-xl p-2 text-sm" rows="10" readOnly value={mail.body} />
                <div className="flex items-center gap-2 mt-2 flex-wrap">
                  <a href={mail.mailto} className="btn bg-blue-600 text-white text-sm">‚úâÔ∏è In E‚ÄëMail √∂ffnen</a>
                  <button className="btn bg-slate-800 text-white text-sm" onclick="navigator.clipboard.writeText(this.parentElement.previousElementSibling.previousElementSibling.value)">üìã Text kopieren</button>
                </div>
              </section>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
